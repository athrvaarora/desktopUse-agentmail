import { NextRequest, NextResponse } from 'next/server';
import Anthropic from '@anthropic-ai/sdk';

interface Message {
  role: 'user' | 'assistant';
  content: string;
}

// Initialize Anthropic client
const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY || '',
});

// MCP Tools available to Claude
const MCP_TOOLS: Anthropic.Tool[] = [
  {
    name: 'get_ui_state',
    description: 'Get the current state of the UI including all visible components, their hierarchy, and available actions. Use this to understand what\'s currently on screen.',
    input_schema: {
      type: 'object',
      properties: {},
      required: [],
    },
  },
  {
    name: 'find_component',
    description: 'Find a component by name, type, or description. Returns matching components with their IDs and available actions.',
    input_schema: {
      type: 'object',
      properties: {
        query: {
          type: 'string',
          description: 'Natural language description or name of the component to find',
        },
        type: {
          type: 'string',
          enum: ['button', 'input', 'modal', 'page', 'card', 'popover', 'dropdown', 'list', 'form', 'slider', 'toggle', 'select', 'textarea', 'dialog'],
          description: 'Optional: Filter by component type',
        },
      },
      required: ['query'],
    },
  },
  {
    name: 'click_component',
    description: 'Click on a button, card, or other clickable component.',
    input_schema: {
      type: 'object',
      properties: {
        componentId: {
          type: 'string',
          description: 'The ID of the component to click',
        },
      },
      required: ['componentId'],
    },
  },
  {
    name: 'type_text',
    description: 'Type text into an input field or textarea.',
    input_schema: {
      type: 'object',
      properties: {
        componentId: {
          type: 'string',
          description: 'The ID of the input/textarea component',
        },
        text: {
          type: 'string',
          description: 'The text to type',
        },
      },
      required: ['componentId', 'text'],
    },
  },
  {
    name: 'execute_custom_action',
    description: 'Execute a custom action on a component (e.g., "setValue", "increase", "decrease" for sliders, "toggle" for toggles).',
    input_schema: {
      type: 'object',
      properties: {
        componentId: {
          type: 'string',
          description: 'The ID of the component',
        },
        actionName: {
          type: 'string',
          description: 'The name of the custom action (e.g., "setValue", "increase", "decrease", "toggle", "enable", "disable")',
        },
        actionValue: {
          type: 'string',
          description: 'Optional value/parameter for the action (e.g., "75" for setValue)',
        },
      },
      required: ['componentId', 'actionName'],
    },
  },
  {
    name: 'navigate_to_component',
    description: 'Navigate to a different component page by clicking the navigation sidebar item.',
    input_schema: {
      type: 'object',
      properties: {
        componentType: {
          type: 'string',
          enum: ['slider', 'input', 'button', 'toggle', 'select', 'textarea', 'card', 'dialog'],
          description: 'The type of component to navigate to',
        },
      },
      required: ['componentType'],
    },
  },
];

export async function POST(request: NextRequest) {
  try {
    const { messages } = await request.json();
    
    if (!messages || messages.length === 0) {
      return NextResponse.json({ error: 'No messages provided' }, { status: 400 });
    }

    if (!process.env.ANTHROPIC_API_KEY) {
      return NextResponse.json({ 
        message: '‚ö†Ô∏è Claude API key not configured. Please add ANTHROPIC_API_KEY to .env.local file.\n\nFor now, I can help you understand the demo, but I cannot control the UI without the API key.' 
      });
    }

    // Convert messages to Anthropic format
    const anthropicMessages = messages.map((msg: Message) => ({
      role: msg.role,
      content: msg.content,
    }));

    // System prompt
    const systemPrompt = `You are an AI assistant that controls a demo website showcasing the Desktop.use SDK. 

The website has 8 component demos: Slider, Input, Button, Toggle, Select, Textarea, Card, and Dialog.

**CRITICAL WORKFLOW**:
When user asks to interact with ANY component:
1. FIRST call navigate_to_component to switch to that page
2. THEN call the appropriate action (execute_custom_action, type_text, click_component)
3. Both tools MUST be called in the same response!

Example: "set slider to 75"
‚Üí Call navigate_to_component with {"componentType": "slider"}
‚Üí Call execute_custom_action with {"componentId": "slider-demo", "actionName": "setValue", "actionValue": "75"}

Example: "type hello in email input"
‚Üí Call navigate_to_component with {"componentType": "input"}
‚Üí Call type_text with {"componentId": "email-input", "text": "hello"}

You can:
1. Navigate between components using navigate_to_component
2. Control components using the MCP tools (click, type, execute_custom_action)
3. Get UI state to understand what's visible

Component IDs:
- Slider: "slider-demo" (custom actions: setValue, increase, decrease)
- Email Input: "email-input" (custom actions: clear)
- Name Input: "name-input" (custom actions: clear)
- Primary Button: "primary-button" (custom actions: click, reset)
- Loading Button: "loading-button" (custom actions: click)
- Notifications Toggle: "toggle-notifications" (custom actions: toggle, enable, disable)
- Dark Mode Toggle: "toggle-dark-mode" (custom actions: toggle, enable, disable)
- Auto-save Toggle: "toggle-auto-save" (custom actions: toggle, enable, disable)
- Country Select: "country-select" (custom actions: selectUSA, selectUK, selectCanada)
- Language Select: "language-select"
- Message Textarea: "message-textarea" (custom actions: clear, append)
- Bio Textarea: "bio-textarea" (custom actions: clear)
- Interactive Card: "interactive-card" (custom actions: expand, collapse, toggle, like, unlike)
- Settings Dialog: "settings-dialog" (custom actions: open, close)
- Confirm Dialog: "confirm-dialog" (custom actions: open, close, confirm, cancel)

Navigation sidebar items:
- nav-item-slider, nav-item-input, nav-item-button, nav-item-toggle, nav-item-select, nav-item-textarea, nav-item-card, nav-item-dialog

**IMPORTANT**: You can call multiple tools in ONE response! For example, if user says "set slider to 75":
1. Call navigate_to_component with {"componentType": "slider"}
2. THEN ALSO call execute_custom_action with {"componentId": "slider-demo", "actionName": "setValue", "actionValue": "75"}

BOTH tools can be called in your SINGLE response - don't stop after just one tool!

Be conversational and helpful. When performing actions, explain what you're doing.`;

    // Call Claude with MCP tools
    const response = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 2048,
      system: systemPrompt,
      messages: anthropicMessages,
      tools: MCP_TOOLS,
    });

    // Handle tool calls - return them to browser for execution via SDK
    let finalResponse = '';
    const toolCalls: Array<{ name: string; input: Record<string, any> }> = [];
    
    for (const content of response.content) {
      if (content.type === 'text') {
        finalResponse += content.text;
      } else if (content.type === 'tool_use') {
        const toolName = content.name;
        const toolInput = content.input as Record<string, any>;
        
        console.log(`[AI Chat] Tool call: ${toolName}`, toolInput);
        
        // Store tool call for browser to execute
        toolCalls.push({ name: toolName, input: toolInput });
        
        // Add user-friendly feedback
        if (toolName === 'navigate_to_component') {
          finalResponse += `\n\n‚úÖ Navigating to ${toolInput.componentType} page...`;
        } else if (toolName === 'execute_custom_action') {
          finalResponse += `\n\n‚úÖ Executing ${toolInput.actionName} on ${toolInput.componentId}...`;
        } else if (toolName === 'type_text') {
          finalResponse += `\n\n‚úÖ Typing "${toolInput.text}" into ${toolInput.componentId}...`;
        } else if (toolName === 'click_component') {
          finalResponse += `\n\n‚úÖ Clicking ${toolInput.componentId}...`;
        } else if (toolName === 'get_ui_state') {
          finalResponse += `\n\nüîç Getting current UI state...`;
        } else if (toolName === 'find_component') {
          finalResponse += `\n\nüîç Finding component: ${toolInput.query}...`;
        }
      }
    }

    if (!finalResponse) {
      finalResponse = 'I understand. How can I help you control the website?';
    }

    return NextResponse.json({ 
      message: finalResponse,
      toolCalls: toolCalls.length > 0 ? toolCalls : undefined
    });
  } catch (error: any) {
    console.error('Chat API error:', error);
    
    if (error?.status === 401) {
      return NextResponse.json({ 
        message: '‚ö†Ô∏è Invalid Claude API key. Please check your ANTHROPIC_API_KEY in .env.local' 
      });
    }
    
    return NextResponse.json({ 
      message: '‚ùå Sorry, I encountered an error. Please try again.' 
    });
  }
}
